---
title: The sigmoidal fit function
author: "Umut Caglar, Claus O Wilke"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The sigmoidal fit function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
**This document needs to be revised along the lines of the linear model document, once the linear model document is final.**
  
  
  # The Sigmoidal Fit Function
  This is a document invetigates details of sigmoidal model 
  
  
```{r install packages, echo=FALSE, warning=FALSE, results='hide',message=FALSE}

###*****************************
# INITIAL COMMANDS TO RESET THE SYSTEM
rm(list = ls())
if (is.integer(dev.list())){dev.off()}
cat("\014")
seedNo=14159
set.seed(seedNo)
###*****************************

###*****************************
require("sicegar")
require("dplyr")
require("ggplot2")
###*****************************
```

## Data generation
To simulate the results, we will go backwards and firstly generate some data to analize. To add some randomness to the input data I will use some noise. The input of all package must be in the form of a data frame with at least 2 columns time and intensity. 

`sicegar::sigmoidalFitFormula` generate a set of intensity values based on maximum, slope parameter and midPoint values supplied. So here we are generating a set of points that are on a sigmoidal with a _/slope parameter/_ of 1, maximum of 4 and midpoint of 8.

The sigmoidal fit formula uses the function  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`y = (0 + (maximum - 0) / (1 + exp((-slopeParam)*(x - midPoint))))`  
and if we calculate the derivative of it at the midpoint we find the slope as  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`max_slope = 1/4 * slopeParam * maximum`  
__i.e what we provide to `sicegar::sigmoidalFitFormula` as slope parameter is not the maximum slope but a parameter related with maximum slope__.

```{r generate data}
time=seq(3,24,0.5)

#simulate intensity data and add noise
noise_parameter=0.1
intensity_noise=stats::runif(n = length(time),min = 0,max = 1)*noise_parameter
intensity=sigmoidalFitFormula(time, maximum = 4, slopeParam = 1, midPoint = 8)
intensity=intensity+intensity_noise

dataInput=data.frame(intensity=intensity,time=time)
```

## Data normalization 

This is the first step. Data should be normalized before any fit. I.e time and intensity should be in between 0-1 interval. 

There is a nuance 

*  Time is normalized with respect to maximum value the time parameter takes.
```{r time normalization, eval=FALSE}
timeRange=max(timeData); timeData=timeData/timeRange
```

*  Intensity is normalized with respect to intensity interval
```{r intensity normalization, eval=FALSE}
intensityMin = min(dataInput$intensity)
intensityMax = max(dataInput$intensity)
intensityRange = intensityMax - intensityMin

intensityData=dataInput$intensity-intensityMin
intensityData=intensityData/intensityRange
```

The normalization code is 

```{r normalize_data}
normalizedInput = sicegar::normalizeData(dataInput = dataInput, 
                                         dataInputName = "Sample001")
```


Components of the normalization output

```{r normalized_data_output}
head(normalizedInput$timeIntensityData) # the normalized time and intensity data
print(normalizedInput$dataScalingParameters) # the normalization parameters that is needed to go back to original scale
print(normalizedInput$dataInputName) # a useful feature to track the sample in all the process
```


## The figures of raw and normalized datasets

```{r plot raw and normal data, echo=FALSE, fig.height=4, fig.width=8}
dataInput %>% dplyr::mutate(process="raw")->dataInput2
normalizedInput$timeIntensityData %>%
  dplyr::mutate(process="normalized")->timeIntensityData2
dplyr::bind_rows(dataInput2,timeIntensityData2) -> combined
combined$process <- factor(combined$process, levels = c("raw","normalized"))

ggplot2::ggplot(combined,aes(x=time, y=intensity))+
  ggplot2::facet_wrap(~process, scales = "free")+
  ggplot2::geom_point()
```

## Sigmoidal fit of the data

Now it is time to calculate the parameters by using `sicegar::sigmoidalFitFunction()`

```{r sigmoidalfit_data}
parameterVector<-sicegar::sigmoidalFitFunction(normalizedInput,tryCounter=2)

# Where tryCounter is a tool usually provided by sicegar::fitFunction when the sicegar::sigmoidalFitFunction is called from sicegar::fitFunction. 

# If tryCounter==1 it took the  start position given by sicegar::fitFunction
# If tryCounter!=1 it generates a random start position from given interval
```

the function outputs a vector that gives information about multiple parameters

```{r parameter vector}
print(t(parameterVector))
```

Here is the brief explanations of the parameters that are given by `sicegar::sigmoidalFitFunction` (In different order then than the output vector of the sigmoidalFitFunction)

These are the parameters of the normalization step 

* `dataScalingParameters.timeRange`: Maximum of raw time data       
* `dataScalingParameters.intensityMin`: Minimum of raw intensity data
* `dataScalingParameters.intensityMax`: Maximum of raw intensity data
* `dataScalingParameters.intensityRange`: Maximum - Minimum of intensity data

They are the meta summary of the result parameters

* `model`: Gives the used model for fitting
* `additionalParameters`: Wheather the additional parameters are calculated or not. The additional parameters are the meaningful parameters for external usage. They can be calculated with the help of `sicegar::parameterCalculation` function.
* `isThisaFit`: FALSE means there is not any successful fit. TRUE means there is at least one successful fit 

Likelihood maximization algorithm starts from a random initiation (if tryCounter!=1) point and goes down the fitness space by a gradient decent algorithm. these parameters represent the start point of the gradient decent algorithm. 

* `startVector.maximum`: Maximum value of the initiation point
* `startVector.slopeParam`: Slope Parameter value of the initiation point
* `startVector.midPoint`: Mid-point value of the initiation point


For each parameter that needs to fitted by LM algorithm; the algorithm gives a bunch of statistical parameters; including the estimated value of the parameter

They are the parameters associated with parameter "maximum"

* `maximum_N_Estimate`: Here N stand for the intersection in the normalized scale
* `maximum_Std_Error`
* `maximum_t_value`
* `maximum_Pr_t`

They are the parameters associated with parameter "slope"

* `slopeParam_N_Estimate`: Here N stand for the intersection in the normalized scale. It is not slope it is a parameter related with slope
* `slopeParam_Std_Error`
* `slopeParam_t_value`
* `slopeParam_Pr_t`

They are the parameters associated with parameter "midpoint"

* `midPoint_N_Estimate`: Here N stand for the intersection in the normalized scale
* `midPoint_Std_Error`
* `midPoint_t_value`
* `midPoint_Pr_t`

They are the parameters associated with the quality of the fit. 

* `residual_Sum_of_Squares`: Small value indicate better fit
* `log_likelihood`: Higher value indicate a better fit
* `AIC_value`: Smaller value indicate a better fit
* `BIC_value`: Smaller value indicate a better fit

They are the fitted values after converting everything from normalized to un-normalized scale. 

* `maximum_Estimate`Maximum intensity estimate for the raw data
* `slopeParam_Estimate`: __Slope parameter__ estimate for the raw data 
* `midPoint_Estimate`: Mid-point estimate (time the intensity reaches 1/2 of maximum) for the raw data

## Check the results to see if the results are meaningfull

By using the `maximum_Estimate`, `slopeParam_Estimate`, `midPoint_Estimate` parameters of the sigmoidalfit and the time sequence that we already created we can calculate the intensity values by the help of `sicegar::sigmoidalFitFormula()`. We can draw the best sigmoidal fit on top of our initial data.

```{r plot raw data and fit, fig.height=4, fig.width=8}
intensityTheoretical=sicegar::sigmoidalFitFormula(time,
                                                  maximum=parameterVector$maximum_Estimate,
                                                  slopeParam=parameterVector$slopeParam_Estimate,
                                                  midPoint=parameterVector$midPoint_Estimate)
comparisonData=cbind(dataInput,intensityTheoretical)

ggplot2::ggplot(comparisonData)+
  ggplot2::geom_point(aes(x=time, y=intensity))+
  ggplot2::geom_line(aes(x=time,y=intensityTheoretical))+
  ggplot2::expand_limits(x = 0, y = 0)
```
